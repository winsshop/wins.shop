<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Ç–∞–ª–æ–≥ –∫—Ä–æ—Å—Å–æ–≤–æ–∫</title>
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      display: flex;
    }
    .sidebar {
      width: 250px;
      padding: 20px;
      background: #fff;
      border-right: 1px solid #ccc;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
    }
    #catalog {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .item {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      width: 220px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      cursor: pointer;
    }
    .item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 4px;
      background: #f5f5f5;
    }
    .item h3 {
      margin: 10px 0 5px;
    }
    .sizes {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .size {
      padding: 2px 5px;
      background: #f0f0f0;
      border-radius: 3px;
    }
    #searchInput {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
      display: block;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-content img {
      max-width: 100%;
      max-height: 300px;
      margin: 10px auto;
      display: block;
    }
    .modal-close {
      position: absolute;
      top: 10px; right: 15px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
    <div id="brandFilters"></div>
    <div id="typeFilters"></div>
  </div>

  <div class="main-content">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ –∫—Ä–æ—Å—Å–æ–≤–æ–∫</h1>
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
    <div id="catalog"><div class="loading">üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...</div></div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <div id="modal-images"></div>
    </div>
  </div>

  <script>
    const API_KEY = "AIzaSyCLIf11ZJ-MOQvV8XUjzUYbXNXXlgMn8XQ";
    const SHEET_ID_SHORT = "1cO0HPxLVgYbc0TayeF6dJf0Z1G8aRqwuK56mXMnKk5U";
    const SHEET_ID_LONG = "1ZUdfEr8ztkJnUWpj7j0H8MvrMRLVt0Fo2NI71KvCmgs";
    const IMAGE_PROXY = "https://images.weserv.nl/?url=";

    const FILTER_CONFIG = {
      excludedKeywords: [
        "–ê–∫–≤–∞—à—É–∑–∏", "–ë—É—Ç—Å–∏", "–®–ª—å–æ–ø–∞–Ω—Ü—ñ", "–®–∏–ø–æ–≤–∫–∏",
        "–§—É—Ç–∑–∞–ª–∫–∏", "–°–æ—Ä–æ–∫–æ–Ω—ñ–∂–∫–∏", "–°–∞–Ω–¥–∞–ª—ñ", "–ö–æ—Ä–∞–ª–∫–∏", "–ö—Ä–æ–∫—Å–∏", "–í'—î—Ç–Ω–∞–º–∫–∏"
      ],
      typePriority: {
        '–ö—Ä–æ—Å—ñ–≤–∫–∏': 1,
        '–ö–µ–¥–∏': 2,
        '–ß–µ—Ä–µ–≤–∏–∫–∏': 3,
        '–ö—Ä–æ–∫—Å–∏': 4,
        'default': 10
      }
    };

    let allProducts = [];

    function formatPrice(price) {
      const str = typeof price === 'string' ? price : price?.toString?.() ?? '';
      const num = parseFloat(str.replace(/\s/g, '').replace(',', '.'));
      return isNaN(num) ? "–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" : `${num.toLocaleString('ru-RU')} ‚Ç¥`;
    }

    function cleanSize(size) {
      return (size || '').toString().replace(/(EU|US|UK)/g, '').trim();
    }

    function processImageUrl(url) {
      if (!url) return null;
      try {
        const parsed = new URL(url);
        return parsed.hostname === '95.216.46.104' ? IMAGE_PROXY + encodeURIComponent(url) : url;
      } catch {
        return null;
      }
    }

    function extractPhotos(photoString) {
      if (!photoString) return [];
      return photoString.split(';').map(s => s.trim()).filter(s => s.startsWith('http')).map(processImageUrl);
    }

    function validateProduct(item) {
      if (!item || !item.name) return false;
      const lowerName = item.name.toLowerCase();
      return !FILTER_CONFIG.excludedKeywords.some(keyword => lowerName.includes(keyword.toLowerCase()));
    }

    async function fetchSheet(sheetId, range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.values || [];
    }

    async function loadCatalog() {
      const [shortData, longData] = await Promise.all([
        fetchSheet(SHEET_ID_SHORT, "TDSheet!A2:Z"),
        fetchSheet(SHEET_ID_LONG, "TDSheet!A2:Z")
      ]);

      const sizeMap = {}, priceMap = {};
      shortData.forEach(row => {
        const article = row[0]?.trim(), size = cleanSize(row[1]), price = row[2];
        if (!article) return;
        if (!sizeMap[article]) sizeMap[article] = new Set();
        if (size) sizeMap[article].add(size);
        const numPrice = parseFloat((price || '').toString().replace(/\s/g, '').replace(',', '.'));
        if (!isNaN(numPrice)) {
          if (!priceMap[article] || numPrice < priceMap[article]) priceMap[article] = numPrice;
        }
      });

      allProducts = [];
      const brands = new Set(), types = new Set();
      const unique = new Set();

      longData.forEach(row => {
        const article = row[0]?.trim();
        const name = row[1]?.trim();
        const type = row[16]?.trim() || "–ù–µ —É–∫–∞–∑–∞–Ω";
        const brand = row[15]?.trim() || "–ù–µ —É–∫–∞–∑–∞–Ω";
        const photoField = row[23];
        const longPrice = row[18];
        if (!article || !name || unique.has(article)) return;

        const photos = extractPhotos(photoField);
        const product = {
          article, name, brand, type,
          photos,
          photo: photos[0] || null,
          sizes: sizeMap[article] ? Array.from(sizeMap[article]).sort() : [],
          price: formatPrice(priceMap[article] || longPrice)
        };

        if (validateProduct(product)) {
          allProducts.push(product);
          unique.add(article);
          brands.add(brand);
          types.add(type);
        }
      });

      renderFilterCheckboxes("brandFilters", Array.from(brands).sort());
      renderFilterCheckboxes("typeFilters", Array.from(types).sort());
      applyFilters();
    }

    function renderFilterCheckboxes(id, items) {
      const container = document.getElementById(id);
      container.innerHTML = items.map(item => `
        <label><input type="checkbox" value="${item}">${item}</label>
      `).join('');
      container.querySelectorAll('input').forEach(el => el.addEventListener('change', applyFilters));
    }

    function applyFilters() {
      const brands = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value);
      const types = Array.from(document.querySelectorAll('#typeFilters input:checked')).map(el => el.value);
      const query = document.getElementById('searchInput').value.toLowerCase();

      const filtered = allProducts.filter(p => {
        const matchBrand = brands.length === 0 || brands.includes(p.brand);
        const matchType = types.length === 0 || types.includes(p.type);
        const matchName = p.name.toLowerCase().includes(query);
        return matchBrand && matchType && matchName;
      });

      renderCatalog(filtered);
    }

    function renderCatalog(products) {
      const container = document.getElementById("catalog");
      if (!products.length) {
        container.innerHTML = `<div class="error">üòê –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º</div>`;
        return;
      }

      const sorted = [...products].sort((a, b) => {
        const getPriority = type => FILTER_CONFIG.typePriority[type] || FILTER_CONFIG.typePriority.default;
        return getPriority(a.type) - getPriority(b.type);
      });

      container.innerHTML = sorted.map(item => `
        <div class="item" data-article="${item.article}">
          <img src="${item.photo || 'data:image/png;base64,...'}" alt="${item.name}">
          <h3>${item.name}</h3>
          <p><strong>–ë—Ä–µ–Ω–¥:</strong> ${item.brand}</p>
          <p><strong>–¢–∏–ø:</strong> ${item.type}</p>
          <div class="sizes">${item.sizes.map(s => `<span class="size">${s}</span>`).join('')}</div>
          <p class="price"><strong>–¶–µ–Ω–∞:</strong> ${item.price}</p>
        </div>
      `).join('');

      document.querySelectorAll('.item').forEach(el => {
        el.addEventListener('click', () => {
          const article = el.getAttribute('data-article');
          const product = allProducts.find(p => p.article === article);
          openModal(product);
        });
      });
    }

    function openModal(product) {
      const modal = document.getElementById("modal");
      const modalImages = document.getElementById("modal-images");
      modalImages.innerHTML = product.photos.map(url => `<img src="${url}" alt="${product.name}">`).join('');
      modal.style.display = "flex";
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.querySelector(".modal-close").addEventListener("click", () => {
      document.getElementById("modal").style.display = "none";
    });
    document.getElementById("modal").addEventListener("click", (e) => {
      if (e.target.id === "modal") document.getElementById("modal").style.display = "none";
    });

    document.addEventListener("DOMContentLoaded", loadCatalog);
  </script>
</body>
</html>
