<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог кроссовок</title>
    <link rel="icon" href="data:,">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9f9f9; }
        h1 { text-align: center; margin-bottom: 20px; }
        
        /* Стили для фильтров и поиска */
        .controls {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-box, .filter-group {
            position: relative;
        }
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .reset-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
        }
        
        /* Стили сортировки и пагинации */
        .sort-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 0 10px;
        }
        .pagination {
            display: flex;
            gap: 5px;
        }
        .page-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: #fff;
        }
        .page-btn.active {
            background: #e53935;
            color: white;
            border-color: #e53935;
        }
        
        /* Каталог */
        #catalog {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 10px;
        }
        .item {
            background: #fff;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .item:hover {
            transform: translateY(-2px);
        }
        .item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        .size {
            padding: 3px 8px;
            background: #f5f5f5;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .price {
            color: #e53935;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* Состояния загрузки */
        .loading, .error {
            text-align: center;
            padding: 30px;
            grid-column: 1 / -1;
        }
        .loading { color: #666; }
        .error { color: #ff4444; }
    </style>
</head>
<body>
    <h1>Каталог кроссовок</h1>
    
    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Поиск по названию...">
            <button class="reset-btn" onclick="document.getElementById('searchInput').value = ''; filterProducts()">×</button>
        </div>
        
        <div class="filter-group">
            <select id="brandFilter" onchange="filterProducts()">
                <option value="">Все бренды</option>
            </select>
        </div>
        
        <div class="filter-group">
            <select id="typeFilter" onchange="filterProducts()">
                <option value="">Все типы</option>
            </select>
        </div>
        
        <div class="filter-group">
            <select id="sizeFilter" onchange="filterProducts()">
                <option value="">Все размеры</option>
            </select>
        </div>
    </div>

    <div class="sort-pagination">
        <div>
            Сортировка:
            <select id="sortSelect" onchange="filterProducts()">
                <option value="default">По умолчанию</option>
                <option value="price_asc">Цена (по возрастанию)</option>
                <option value="price_desc">Цена (по убыванию)</option>
                <option value="name_asc">Название (А-Я)</option>
                <option value="name_desc">Название (Я-А)</option>
            </select>
        </div>
        
        <div class="pagination" id="pagination"></div>
    </div>

    <div id="catalog"></div>

    <script>
        const API_KEY = "AIzaSyCLIf11ZJ-MOQvV8XUjzUYbXNXXlgMn8XQ";
        const SHEET_ID_SHORT = "1cO0HPxLVgYbc0TayeF6dJf0Z1G8aRqwuK56mXMnKk5U";
        const SHEET_ID_LONG = "1ZUdfEr8ztkJnUWpj7j0H8MvrMRLVt0Fo2NI71KvCmgs";
        const IMAGE_PROXY = "https://images.weserv.nl/?url=";
        const ITEMS_PER_PAGE = 12;

        let allProducts = [];
        let currentPage = 1;
        let totalPages = 1;

        const FILTER_CONFIG = {
            excludedBrands: ["Joma"],
            excludedKeywords: [
                "М'яч", "Пуховик", "плавки", "ракетка",
                "футболка", "чохол", "шкарпетки", "шорти",
                "штани", "боксерки", "гетри", "кофта"
            ],
            typePriority: {
                'Кросівки': 1,
                'Кеди': 2,
                'Черевики': 3,
                'default': 4,
                'Аквашузи': 5,
                'Бутси': 5,
                'Крокси': 5,
                'Коралки': 5,
                "В'єтнамки": 5
            }
        };

        // Оптимизация: кэширование DOM элементов
        const dom = {
            catalog: document.getElementById('catalog'),
            searchInput: document.getElementById('searchInput'),
            brandFilter: document.getElementById('brandFilter'),
            typeFilter: document.getElementById('typeFilter'),
            sizeFilter: document.getElementById('sizeFilter'),
            sortSelect: document.getElementById('sortSelect'),
            pagination: document.getElementById('pagination')
        };

        // Основная функция загрузки данных
        async function loadCatalog() {
            try {
                showLoading();
                
                const [shortData, longData] = await Promise.all([
                    fetchSheet(SHEET_ID_SHORT, "TDSheet!A2:Z"),
                    fetchSheet(SHEET_ID_LONG, "TDSheet!A2:Z")
                ]);

                const processedData = processData(shortData, longData);
                allProducts = processedData.filter(validateProduct);
                
                initFilters(processedData);
                filterProducts();
            } catch (error) {
                showError(error);
            }
        }

        // Инициализация фильтров
        function initFilters(products) {
            const brands = new Set();
            const types = new Set();
            const sizes = new Set();

            products.forEach(product => {
                brands.add(product.brand);
                types.add(product.type);
                product.sizes.forEach(size => sizes.add(size));
            });

            populateFilter(dom.brandFilter, brands);
            populateFilter(dom.typeFilter, types);
            populateFilter(dom.sizeFilter, sizes);
        }

        function populateFilter(filterElement, values) {
            Array.from(values).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                filterElement.appendChild(option);
            });
        }

        // Функция фильтрации и сортировки
        function filterProducts(page = 1) {
            currentPage = page;
            const filtered = allProducts
                .filter(product => matchesFilters(product))
                .sort(getSortFunction());

            totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
            renderProducts(paginate(filtered));
            renderPagination();
        }

        function matchesFilters(product) {
            const searchQuery = dom.searchInput.value.toLowerCase();
            const brand = dom.brandFilter.value;
            const type = dom.typeFilter.value;
            const size = dom.sizeFilter.value;

            return (
                product.name.toLowerCase().includes(searchQuery) &&
                (!brand || product.brand === brand) &&
                (!type || product.type === type) &&
                (!size || product.sizes.includes(size))
            );
        }

        function getSortFunction() {
            const sortKey = dom.sortSelect.value;
            
            switch(sortKey) {
                case 'price_asc': 
                    return (a, b) => parsePrice(a.price) - parsePrice(b.price);
                case 'price_desc': 
                    return (a, b) => parsePrice(b.price) - parsePrice(a.price);
                case 'name_asc': 
                    return (a, b) => a.name.localeCompare(b.name);
                case 'name_desc': 
                    return (a, b) => b.name.localeCompare(a.name);
                default: 
                    return sortProducts;
            }
        }

        function parsePrice(priceStr) {
            return parseInt(priceStr.replace(/[^\d]/g, '')) || 0;
        }

        // Пагинация
        function paginate(items) {
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            return items.slice(start, start + ITEMS_PER_PAGE);
        }

        function renderPagination() {
            let buttons = '';
            for (let i = 1; i <= totalPages; i++) {
                buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                             onclick="filterProducts(${i})">${i}</button>`;
            }
            dom.pagination.innerHTML = buttons;
        }

        // Рендеринг товаров
        function renderProducts(products) {
            dom.catalog.innerHTML = products.length > 0 
                ? products.map(renderProduct).join('')
                : '<div class="error">😐 Товары не найдены</div>';
        }

        function renderProduct(product) {
            return `
                <div class="item">
                    <img src="${product.photo || getPlaceholderImage()}" 
                         alt="${product.name}"
                         loading="lazy"
                         onerror="this.src='${getPlaceholderImage()}'">
                    <h3>${product.name}</h3>
                    <p>Бренд: ${product.brand}</p>
                    <p>Тип: ${product.type}</p>
                    <div class="sizes">
                        ${product.sizes.map(size => `<span class="size">${size}</span>`).join('')}
                    </div>
                    <p class="price">${product.price}</p>
                </div>
            `;
        }

        // Вспомогательные функции
        function getPlaceholderImage() {
            return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        }

        function showLoading() {
            dom.catalog.innerHTML = '<div class="loading">🔄 Загружаем товары...</div>';
        }

        function showError(error) {
            dom.catalog.innerHTML = `
                <div class="error">
                    ❌ Ошибка загрузки: ${error.message}
                </div>
            `;
        }

        // Остальные функции (processData, fetchSheet, validateProduct и др.) 
        // остаются без изменений как в предыдущей версии кода

        // Инициализация
        document.addEventListener('DOMContentLoaded', loadCatalog);
    </script>
</body>
</html>
