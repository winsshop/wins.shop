<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Ç–∞–ª–æ–≥ –∫—Ä–æ—Å—Å–æ–≤–æ–∫</title>
  <link rel="icon" href="data:,">
  <style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      display: flex;
    }

    .sidebar {
      width: 250px;
      padding: 20px;
      background: #fff;
      border-right: 1px solid #ccc;
    }

    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */

    .error {
      font-size: 18px;
      padding: 20px;
      width: 100%;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <!-- –§–∏–ª—å—Ç—Ä—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
    <div class="filter-section">
      <strong>–ë—Ä–µ–Ω–¥—ã</strong>
      <div id="brandFilters"></div>
    </div>
    <div class="filter-section">
      <strong>–†–∞–∑–º–µ—Ä—ã</strong>
      <select id="sizeStandard" class="size-standard-select">
        <option value="EU" selected>EU</option>
        <option value="US">US</option>
        <option value="UK">UK</option>
        <option value="UA">UA</option>
        <option value="CM">CM</option>
      </select>
      <div id="sizeFilters"></div>
    </div>
    <div class="filter-section">
      <strong>–¢–∏–ø—ã</strong>
      <div id="typeFilters"></div>
    </div>
  </div>

  <div class="main-content">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ –∫—Ä–æ—Å—Å–æ–≤–æ–∫</h1>
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
    <div id="catalog"><div class="loading">üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...</div></div>
  </div>

  <script>
    const API_KEY = "AIzaSyCLIf11ZJ-MOQvV8XUjzUYbXNXXlgMn8XQ";
    const SHEET_ID_SHORT = "1cO0HPxLVgYbc0TayeF6dJf0Z1G8aRqwuK56mXMnKk5U";
    const SHEET_ID_LONG = "1ZUdfEr8ztkJnUWpj7j0H8MvrMRLVt0Fo2NI71KvCmgs";
    const IMAGE_PROXY = "https://images.weserv.nl/?url=";

    const FILTER_CONFIG = {
      excludedBrands: ["Joma"],
      excludedKeywords: [
        "–ú'—è—á", "–ü—É—Ö–æ–≤–∏–∫", "–ø–ª–∞–≤–∫–∏", "—Ä–∞–∫–µ—Ç–∫–∞",
        "—Ñ—É—Ç–±–æ–ª–∫–∞", "—á–æ—Ö–æ–ª", "—à–∫–∞—Ä–ø–µ—Ç–∫–∏", "—à–æ—Ä—Ç–∏",
        "—à—Ç–∞–Ω–∏", "–±–æ–∫—Å–µ—Ä–∫–∏", "–≥–µ—Ç—Ä–∏", "–∫–æ—Ñ—Ç–∞"
      ],
      typePriority: {
        '–ö—Ä–æ—Å—ñ–≤–∫–∏': 1,
        '–ö–µ–¥–∏': 2,
        '–ß–µ—Ä–µ–≤–∏–∫–∏': 3,
        '–ö—Ä–æ–∫—Å–∏': 4,
        'default': 10
      }
    };

    let allProducts = [];

    function processImageUrl(originalUrl) {
      if (!originalUrl) return null;
      try {
        const url = new URL(originalUrl);
        if (url.hostname === '95.216.46.104') {
          return IMAGE_PROXY + encodeURIComponent(url.href);
        }
        return originalUrl;
      } catch {
        return null;
      }
    }

    function extractFirstPhoto(photoString) {
      if (!photoString) return null;
      const photos = photoString.split(';').map(url => url.trim()).filter(url => url.startsWith('http'));
      return photos.length > 0 ? photos[0] : null;
    }

    function formatPrice(price) {
      if (!price) return "–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞";
      const numericPrice = parseFloat(price.toString().replace(/\s/g, '').replace(',', '.'));
      return isNaN(numericPrice) ? "–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" : `${numericPrice.toLocaleString('ru-RU')} ‚Ç¥`;
    }

    function cleanSize(size) {
      return (size || '').toString().replace(/(EU|US|UK)/g, '').trim();
    }

    function validateProduct(item) {
      if (!item || !item.name || !item.brand) return false;
      if (FILTER_CONFIG.excludedBrands.includes(item.brand.trim())) return false;
      const lowerName = item.name.toLowerCase();
      return !FILTER_CONFIG.excludedKeywords.some(keyword => lowerName.includes(keyword.toLowerCase()));
    }

    async function fetchSheet(sheetId, range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        return data.values || [];
      } catch {
        return [];
      }
    }

    function renderCatalog(products) {
      const container = document.getElementById("catalog");
      if (!products.length) {
        container.innerHTML = `<div class="error">üòê –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º</div>`;
        return;
      }

      container.innerHTML = products.map(item => `
        <div class="item">
          <img src="${item.photo || 'data:image/png;base64,...'}" alt="${item.name}">
          <h3>${item.name}</h3>
          <p><strong>–ë—Ä–µ–Ω–¥:</strong> ${item.brand}</p>
          <p><strong>–¢–∏–ø:</strong> ${item.type}</p>
          <p><strong>–†–∞–∑–º–µ—Ä—ã:</strong></p>
          <div class="sizes">${item.sizes.map(size => `<span class="size">${size}</span>`).join('')}</div>
          <p class="price"><strong>–¶–µ–Ω–∞:</strong> ${item.price}</p>
        </div>
      `).join('');
    }

    function applyFilters() {
      const brandChecks = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value);
      const typeChecks = Array.from(document.querySelectorAll('#typeFilters input:checked')).map(el => el.value);
      const sizeChecks = Array.from(document.querySelectorAll('#sizeFilters input:checked')).map(el => el.value);
      const query = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allProducts.filter(item => {
        const matchesBrand = brandChecks.length === 0 || brandChecks.includes(item.brand);
        const matchesType = typeChecks.length === 0 || typeChecks.includes(item.type);
        const matchesSize = sizeChecks.length === 0 || item.sizes.some(size => sizeChecks.includes(size));
        const matchesName = item.name.toLowerCase().includes(query);
        return matchesBrand && matchesType && matchesSize && matchesName;
      });

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º
      filtered.sort((a, b) => {
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–∏–ø–æ–≤
        const priorityA = FILTER_CONFIG.typePriority[a.type] || FILTER_CONFIG.typePriority.default;
        const priorityB = FILTER_CONFIG.typePriority[b.type] || FILTER_CONFIG.typePriority.default;
        
        if (priorityA !== priorityB) {
          return priorityA - priorityB;
        }

        // –í–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ö—Ä–æ—Å—ñ–≤–∫–∏" —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        if (a.type === '–ö—Ä–æ—Å—ñ–≤–∫–∏' && b.type === '–ö—Ä–æ—Å—ñ–≤–∫–∏') {
          const aIsGeneric = a.name.toLowerCase() === '–∫—Ä–æ—Å—ñ–≤–∫–∏';
          const bIsGeneric = b.name.toLowerCase() === '–∫—Ä–æ—Å—ñ–≤–∫–∏';
          
          if (aIsGeneric && !bIsGeneric) return 1;
          if (!aIsGeneric && bIsGeneric) return -1;
        }

        return a.name.localeCompare(b.name);
      });

      renderCatalog(filtered);
    }

    function renderFilterCheckboxes(id, items) {
      const container = document.getElementById(id);
      container.innerHTML = items.map(item => `
        <label><input type="checkbox" value="${item}">${item}</label>
      `).join('');
      container.querySelectorAll('input').forEach(el => {
        el.addEventListener('change', applyFilters);
      });
    }

    async function loadCatalog() {
      const [shortData, longData] = await Promise.all([
        fetchSheet(SHEET_ID_SHORT, "TDSheet!A2:Z"),
        fetchSheet(SHEET_ID_LONG, "TDSheet!A2:Z")
      ]);

      const sizeMap = {}, priceMap = {};
      shortData.forEach(row => {
        const article = row[0]?.trim(), size = cleanSize(row[1]), price = row[2];
        if (article) {
          if (!sizeMap[article]) sizeMap[article] = new Set();
          if (size) sizeMap[article].add(size);
          const numPrice = parseFloat((price || '').replace(/\s/g, '').replace(',', '.'));
          if (!isNaN(numPrice)) {
            if (!priceMap[article] || numPrice < priceMap[article]) priceMap[article] = numPrice;
          }
        }
      });

      const brandSet = new Set(), typeSet = new Set(), sizeSet = new Set();
      const uniqueArticles = new Set();
      allProducts = [];

      longData.forEach(row => {
        const article = row[0]?.trim();
        const name = row[1]?.trim();
        const typeRaw = row[16]?.trim();
        const brand = row[15]?.trim();
        const photo = processImageUrl(extractFirstPhoto(row[23]));
        const longPrice = row[18];
        const type = typeRaw === '–í–∑—É—Ç—Ç—è' ? '–ö—Ä–æ—Å—ñ–≤–∫–∏' : typeRaw;

        if (!article || !name || typeRaw !== "–í–∑—É—Ç—Ç—è") return;
        if (uniqueArticles.has(article)) return;

        const sizes = sizeMap[article] ? Array.from(sizeMap[article]).sort() : [];
        const product = {
          article, name, brand: brand || "–ù–µ —É–∫–∞–∑–∞–Ω", type,
          photo, sizes, price: formatPrice(priceMap[article] || longPrice)
        };

        if (validateProduct(product)) {
          allProducts.push(product);
          uniqueArticles.add(article);
          brandSet.add(product.brand);
          typeSet.add(product.type);
          product.sizes.forEach(s => sizeSet.add(s));
        }
      });

      renderFilterCheckboxes("brandFilters", Array.from(brandSet).sort());
      renderFilterCheckboxes("typeFilters", Array.from(typeSet).sort());
      renderFilterCheckboxes("sizeFilters", Array.from(sizeSet).sort());
      applyFilters();
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.addEventListener("DOMContentLoaded", loadCatalog);
  </script>
</body>
</html>
