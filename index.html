<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог кроссовок</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .product { border: 1px solid #ddd; padding: 10px; margin: 10px; display: inline-block; width: 300px; }
        .product img { width: 100%; height: auto; }
    </style>
</head>
<body>
    <h1>Каталог кроссовок</h1>
    <div id="products"></div>
    
    <script>
        async function fetchData() {
            const sheetId = "1UySe27uevjq_g2XDy1aCiUYr6JVZRiw3j3UZ97dvTBM"; // Длинная таблица
            const sheetIdShort = "1cO0HPxLVgYbc0TayeF6dJf0Z1G8aRqwuK56mXMnKk5U"; // Короткая таблица
            const apiKey = "AIzaSyCmpRHMLI_mJI-nF_99Zw-WhbEIWfk_a4Y";
            
            const longUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1?key=${apiKey}`;
            const shortUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetIdShort}/values/Sheet1?key=${apiKey}`;
            
            const longData = await fetch(longUrl).then(res => res.json());
            const shortData = await fetch(shortUrl).then(res => res.json());
            
            const products = processData(longData.values, shortData.values);
            displayProducts(products);
        }
        
        function processData(longData, shortData) {
            const products = {};
            
            longData.slice(1).forEach(row => {
                const [name, article, sizes] = row;
                products[article] = { name, article, sizes, availability: [] };
            });
            
            shortData.slice(1).forEach(row => {
                const [article, size, price, stock] = row;
                if (products[article]) {
                    products[article].availability.push({ size, price, stock });
                }
            });
            
            return Object.values(products);
        }
        
        async function getSneakerImages(article) {
            const searchUrl = `https://7dreamsport.ua/search?query=${article}`;
            try {
                const response = await fetch(searchUrl);
                const text = await response.text();
                const imageUrls = [...text.matchAll(/<img src=\"(https:\/\/7dreamsport\.ua\/uploads\/products\/.*?)\"/g)]
                                    .map(match => match[1]);
                return imageUrls.length ? imageUrls : ["placeholder.jpg"];
            } catch (error) {
                console.error("Ошибка загрузки изображений: ", error);
                return ["placeholder.jpg"];
            }
        }
        
        async function displayProducts(products) {
            const container = document.getElementById("products");
            container.innerHTML = "";
            
            for (const product of products) {
                const imageUrls = await getSneakerImages(product.article);
                
                const div = document.createElement("div");
                div.className = "product";
                div.innerHTML = `
                    <h3>${product.name}</h3>
                    ${imageUrls.map(url => `<img src="${url}" alt="${product.name}">`).join('')}
                    <p>Артикул: ${product.article}</p>
                    <p>Размеры: ${product.sizes}</p>
                    <p>Наличие:</p>
                    <ul>
                        ${product.availability.map(a => `<li>${a.size} - ${a.price} грн (${a.stock})</li>`).join('')}
                    </ul>
                `;
                container.appendChild(div);
            }
        }
        
        fetchData();
    </script>
</body>
</html>
