<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Ç–∞–ª–æ–≥ –∫—Ä–æ—Å—Å–æ–≤–æ–∫</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background: #f9f9f9; }
    h1 { margin-bottom: 20px; }
    #controls { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    select, input[type="text"] {
      padding: 6px 10px; font-size: 14px; border-radius: 5px;
      border: 1px solid #ccc; min-width: 150px;
    }
    #catalog { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .item {
      background: #fff; border: 1px solid #ccc; padding: 15px; width: 220px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px;
    }
    .item img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; background: #f5f5f5; }
    .item h3 { margin: 10px 0 5px; }
    .item p { margin: 4px 0; font-size: 14px; }
    .price { font-weight: bold; color: #e53935; }
    .sizes { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .size { padding: 2px 5px; background: #f0f0f0; border-radius: 3px; }
    .loading { font-size: 18px; padding: 20px; }
    .error { color: red; font-size: 18px; padding: 20px; }
  </style>
</head>
<body>
  <h1>–ö–∞—Ç–∞–ª–æ–≥ –∫—Ä–æ—Å—Å–æ–≤–æ–∫</h1>

  <div id="controls">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
    <select id="brandFilter"><option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option></select>
    <select id="sizeFilter"><option value="">–í—Å–µ —Ä–∞–∑–º–µ—Ä—ã</option></select>
    <select id="typeFilter"><option value="">–í—Å–µ —Ç–∏–ø—ã</option></select>
    <select id="sortSelect">
      <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
      <option value="priceAsc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
      <option value="priceDesc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
      <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ (–∑–∞–≥–ª—É—à–∫–∞)</option>
    </select>
  </div>

  <div id="catalog"><div class="loading">üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...</div></div>

  <script>
    const API_KEY = "AIzaSyCLIf11ZJ-MOQvV8XUjzUYbXNXXlgMn8XQ";
    const SHEET_ID_SHORT = "1cO0HPxLVgYbc0TayeF6dJf0Z1G8aRqwuK56mXMnKk5U";
    const SHEET_ID_LONG = "1ZUdfEr8ztkJnUWpj7j0H8MvrMRLVt0Fo2NI71KvCmgs";
    const IMAGE_PROXY = "https://images.weserv.nl/?url=";

    const FILTER_CONFIG = {
      excludedBrands: ["Joma"],
      excludedKeywords: [
        "–ú'—è—á", "–ü—É—Ö–æ–≤–∏–∫", "–ø–ª–∞–≤–∫–∏", "—Ä–∞–∫–µ—Ç–∫–∞",
        "—Ñ—É—Ç–±–æ–ª–∫–∞", "—á–æ—Ö–æ–ª", "—à–∫–∞—Ä–ø–µ—Ç–∫–∏", "—à–æ—Ä—Ç–∏",
        "—à—Ç–∞–Ω–∏", "–±–æ–∫—Å–µ—Ä–∫–∏", "–≥–µ—Ç—Ä–∏", "–∫–æ—Ñ—Ç–∞"
      ],
      typePriority: {
        '–ö—Ä–æ—Å—ñ–≤–∫–∏': 1, '–ö–µ–¥–∏': 2, '–ß–µ—Ä–µ–≤–∏–∫–∏': 3,
        'default': 4, '–ê–∫–≤–∞—à—É–∑–∏': 5, '–ë—É—Ç—Å–∏': 5,
        '–ö—Ä–æ–∫—Å–∏': 5, '–ö–æ—Ä–∞–ª–∫–∏': 5, "–í'—î—Ç–Ω–∞–º–∫–∏": 5
      }
    };

    function processImageUrl(url) {
      try {
        const parsed = new URL(url);
        return parsed.hostname === '95.216.46.104' ? IMAGE_PROXY + encodeURIComponent(url) : url;
      } catch { return null; }
    }

    function extractFirstPhoto(photoString) {
      if (!photoString) return null;
      return photoString.split(';').map(s => s.trim()).find(u => u.startsWith('http')) || null;
    }

    function formatPrice(price) {
      const num = parseFloat(price?.toString().replace(/\s/g, '').replace(',', '.'));
      return isNaN(num) ? "–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" : `${num.toLocaleString('ru-RU')} ‚Ç¥`;
    }

    function cleanSize(size) {
      return size?.replace(/(EU|US)/g, '').trim();
    }

    function validateProduct(item) {
      if (!item.name || !item.brand) return false;
      if (FILTER_CONFIG.excludedBrands.includes(item.brand.trim())) return false;
      const nameLower = item.name.toLowerCase();
      return !FILTER_CONFIG.excludedKeywords.some(k => nameLower.includes(k.toLowerCase()));
    }

    function resolveType(name, type) {
      const lName = name.toLowerCase(), lType = type.toLowerCase();
      if (lType.includes('–∫—Ä–æ—Å—ñ–≤–∫–∏') || lName.includes('–∫—Ä–æ—Å—ñ–≤–∫–∏')) return '–ö—Ä–æ—Å—ñ–≤–∫–∏';
      if (lType.includes('–∫–µ–¥–∏') || lName.includes('–∫–µ–¥–∏')) return '–ö–µ–¥–∏';
      if (lType.includes('—á–µ—Ä–µ–≤–∏–∫–∏') || lName.includes('—á–µ—Ä–µ–≤–∏–∫–∏')) return '–ß–µ—Ä–µ–≤–∏–∫–∏';
      if (lName.includes('–∞–∫–≤–∞—à—É–∑')) return '–ê–∫–≤–∞—à—É–∑–∏';
      if (lName.includes('–±—É—Ç—Å')) return '–ë—É—Ç—Å–∏';
      if (lName.includes('–∫—Ä–æ–∫—Å')) return '–ö—Ä–æ–∫—Å–∏';
      if (lName.includes('–∫–æ—Ä–∞–ª')) return '–ö–æ—Ä–∞–ª–∫–∏';
      if (lName.includes("–≤'—î—Ç–Ω–∞–º")) return "–í'—î—Ç–Ω–∞–º–∫–∏";
      return type;
    }

    let allProducts = [];
    const catalogEl = document.getElementById("catalog");

    async function fetchSheet(sheetId, range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.values || [];
    }

    async function loadData() {
      const [shortData, longData] = await Promise.all([
        fetchSheet(SHEET_ID_SHORT, "TDSheet!A2:Z"),
        fetchSheet(SHEET_ID_LONG, "TDSheet!A2:Z")
      ]);

      const sizeMap = {}, priceMap = {}, result = [], seen = new Set();
      shortData.forEach(row => {
        const article = row?.[0]?.trim();
        const size = cleanSize(row?.[1]);
        const price = row?.[2];
        if (!article) return;
        sizeMap[article] = sizeMap[article] || new Set();
        if (size) sizeMap[article].add(size);
        const num = parseFloat(price?.toString().replace(/\s/g, '').replace(',', '.'));
        if (!isNaN(num)) {
          priceMap[article] = priceMap[article] ? Math.min(priceMap[article], num) : num;
        }
      });

      longData.forEach(row => {
        const article = row?.[0]?.trim();
        const name = row?.[1]?.trim();
        const type = row?.[16]?.trim();
        const brand = row?.[15]?.trim();
        const photos = row?.[23];
        const longPrice = row?.[18];
        if (!article || !name || type !== "–í–∑—É—Ç—Ç—è" || seen.has(article)) return;
        const product = {
          article, name, brand: brand || "–ù–µ —É–∫–∞–∑–∞–Ω",
          type: resolveType(name, type), photo: processImageUrl(extractFirstPhoto(photos)),
          sizes: sizeMap[article] ? Array.from(sizeMap[article]).sort() : ["–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"],
          rawPrice: priceMap[article] || longPrice,
          price: formatPrice(priceMap[article] || longPrice)
        };
        if (validateProduct(product)) {
          seen.add(article);
          result.push(product);
        }
      });

      allProducts = result;
      populateFilters();
      renderProducts(result);
    }

    function populateFilters() {
      const brandSet = new Set(), sizeSet = new Set(), typeSet = new Set();
      allProducts.forEach(p => {
        brandSet.add(p.brand);
        p.sizes.forEach(s => sizeSet.add(s));
        typeSet.add(p.type);
      });

      fillSelect('brandFilter', [...brandSet].sort());
      fillSelect('sizeFilter', [...sizeSet].sort((a, b) => parseFloat(a) - parseFloat(b)));
      fillSelect('typeFilter', [...typeSet].sort());
    }

    function fillSelect(id, items) {
      const select = document.getElementById(id);
      items.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    }

    function renderProducts(products) {
      catalogEl.innerHTML = products.length
        ? products.map(item => `
        <div class="item">
          <img src="${item.photo || 'data:image/png;base64,...'}"
               alt="${item.name}" onerror="this.src='data:image/png;base64,...'">
          <h3>${item.name}</h3>
          <p><strong>–ë—Ä–µ–Ω–¥:</strong> ${item.brand}</p>
          <p><strong>–¢–∏–ø:</strong> ${item.type}</p>
          <p><strong>–†–∞–∑–º–µ—Ä—ã:</strong></p>
          <div class="sizes">${item.sizes.map(s => `<span class="size">${s}</span>`).join('')}</div>
          <p class="price"><strong>–¶–µ–Ω–∞:</strong> ${item.price}</p>
        </div>`).join('')
        : '<div class="error">üòê –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.</div>';
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const brand = document.getElementById("brandFilter").value;
      const size = document.getElementById("sizeFilter").value;
      const type = document.getElementById("typeFilter").value;
      const sort = document.getElementById("sortSelect").value;

      let filtered = allProducts.filter(p =>
        (!brand || p.brand === brand) &&
        (!type || p.type === type) &&
        (!size || p.sizes.includes(size)) &&
        (!search || p.name.toLowerCase().includes(search))
      );

      if (sort === 'priceAsc') filtered.sort((a, b) => parseFloat(a.rawPrice) - parseFloat(b.rawPrice));
      if (sort === 'priceDesc') filtered.sort((a, b) => parseFloat(b.rawPrice) - parseFloat(a.rawPrice));
      if (sort === 'popular') filtered.sort(() => Math.random()); // –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞

      renderProducts(filtered);
    }

    let searchDebounce;
    document.getElementById("searchInput").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(applyFilters, 300);
    });

    ["brandFilter", "sizeFilter", "typeFilter", "sortSelect"].forEach(id =>
      document.getElementById(id).addEventListener("change", applyFilters)
    );

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
