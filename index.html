<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Каталог кроссовок</title>
  <link rel="icon" href="data:,">
  <style>
    :root {
      --primary-color: #3f51b5;
      --secondary-color: #f50057;
      --light-gray: #f5f5f5;
      --medium-gray: #e0e0e0;
      --dark-gray: #757575;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --radius: 8px;
    }
    
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--light-gray);
      display: flex;
      color: #333;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid var(--medium-gray);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      flex-shrink: 0; /* Этот параметр не позволит меню сжиматься */
    }
    
    .sidebar-header {
      padding: 20px;
      background: var(--primary-color);
      color: white;
    }
    
    .sidebar-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 500;
    }
    
    .filter-section {
      margin-bottom: 10px;
      border-bottom: 1px solid var(--medium-gray);
    }
    
    .filter-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .filter-title:hover {
      background-color: rgba(63, 81, 181, 0.05);
    }
    
    .filter-title::after {
      content: '▼';
      font-size: 12px;
      transition: transform 0.3s;
    }
    
    .filter-title.collapsed::after {
      transform: rotate(-90deg);
    }
    
    .filter-content {
      max-height: 300px;
      overflow-y: auto;
      padding: 0 20px 15px;
      transition: max-height 0.3s ease;
    }
    
    .filter-content.collapsed {
      max-height: 0;
      overflow: hidden;
      padding-top: 0;
      padding-bottom: 0;
    }
    
    .filter-section label {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
    }
    
    .filter-section input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
    
    .size-standard-select {
      margin: 0 0 15px;
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--medium-gray);
    }
    
    .main-content {
      flex-grow: 1;
      padding: 30px;
      min-width: 0; /* Важно для корректного flex-отображения */
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      margin: 0 0 20px;
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .search-container {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    #searchInput {
      width: 100%;
      max-width: 500px;
      padding: 12px 15px;
      font-size: 16px;
      border: 1px solid var(--medium-gray);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: box-shadow 0.3s;
    }
    
    #searchInput:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
    }
    
    #catalog {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      justify-content: center;
    }
    
    .item {
      background: white;
      border-radius: var(--radius);
      width: 260px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }
    
    .item:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .item-img-container {
      height: 180px;
      overflow: hidden;
      position: relative;
    }
    
    .item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    
    .item:hover img {
      transform: scale(1.05);
    }
    
    .item-content {
      padding: 15px;
    }
    
    .item h3 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #333;
      line-height: 1.3;
    }
    
    .item-info {
      margin: 5px 0;
      font-size: 14px;
      display: flex;
    }
    
    .item-info strong {
      width: 75px;
      color: var(--dark-gray);
    }
    
    .sizes {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    
    .size {
      padding: 3px 7px;
      background: var(--light-gray);
      border-radius: 3px;
      font-size: 12px;
    }
    
    .price {
      margin-top: 15px;
      font-weight: bold;
      color: var(--secondary-color);
      font-size: 18px;
    }
    
    .loading, .error {
      font-size: 18px;
      padding: 40px;
      width: 100%;
      text-align: center;
      color: var(--dark-gray);
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(63, 81, 181, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .sizes-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }
    
    .sizes-grid label {
      display: block;
      text-align: center;
      margin: 0;
    }
    
    .counter {
      background: var(--primary-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .popular-brand {
      font-weight: 500;
    }
    
    /* Новые стили */
    .size-type-info {
      font-size: 13px;
      color: var(--dark-gray);
      margin-top: 5px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    
    .size-badge {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      font-size: 11px;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 5px;
    }
    
    /* Стили для мобильной версии */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 50vh;
        position: relative;
      }
      
      .sidebar-header {
        padding: 15px;
      }
      
      .main-content {
        padding: 20px 15px;
      }
      
      .item {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Фильтры</h2>
    </div>
    <div class="filter-section">
      <div class="filter-title" onclick="toggleFilter(this)">
        Бренды <span id="brandCounter" class="counter">0</span>
      </div>
      <div class="filter-content" id="brandContainer">
        <div id="brandFilters"></div>
      </div>
    </div>
    <div class="filter-section">
      <div class="filter-title" onclick="toggleFilter(this)">
        Размеры <span id="sizeCounter" class="counter">0</span>
      </div>
      <div class="filter-content" id="sizeContainer">
        <select id="sizeStandard" class="size-standard-select">
          <option value="EU" selected>EU (Европейский)</option>
          <option value="US">US (Американский) - М</option>
          <option value="UK">UK (Британский)</option>
          <option value="UA">UA (Украинский)</option>
          <option value="CM">CM (Сантиметры)</option>
        </select>
        <div class="sizes-grid" id="sizeFilters"></div>
      </div>
    </div>
    <div class="filter-section">
      <div class="filter-title" onclick="toggleFilter(this)">
        Типы <span id="typeCounter" class="counter">0</span>
      </div>
      <div class="filter-content" id="typeContainer">
        <div id="typeFilters"></div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <h1>Каталог кроссовок</h1>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Поиск по названию...">
      </div>
    </div>
    <div id="catalog">
      <div class="loading">
        <div class="loading-spinner"></div>
        Загружаем товары...
      </div>
    </div>
  </div>

  <script>
    const API_KEY = "AIzaSyCLIf11ZJ-MOQvV8XUjzUYbXNXXlgMn8XQ";
    const SHEET_ID_SHORT = "1cO0HPxLVgYbc0TayeF6dJf0Z1G8aRqwuK56mXMnKk5U";
    const SHEET_ID_LONG = "1ZUdfEr8ztkJnUWpj7j0H8MvrMRLVt0Fo2NI71KvCmgs";
    const IMAGE_PROXY = "https://images.weserv.nl/?url=";

    const FILTER_CONFIG = {
      excludedBrands: ["Joma"],
      excludedKeywords: [
        "М'яч", "Пуховик", "плавки", "ракетка",
        "футболка", "чохол", "шкарпетки", "шорти",
        "штани", "боксерки", "гетри", "кофта",
        "Аквашузи", "Бутси", "Шльопанці", "Шиповки",
        "Футзалки", "Сороконіжки", "Сандалі", "Коралки", "Крокси", "В'єтнамки", "Дитячі", 
      ],
      typePriority: {
        'Кросівки': 1,
        'Кеди': 2,
        'Черевики': 3,
        'Крокси': 4,
        'default': 10
      },
      popularBrands: [
        "Nike", "Adidas", "Puma", "New Balance", "Reebok", 
        "Asics", "Under Armour", "Converse", "Vans", "Jordan"
      ]
    };

    // Таблица конвертации размеров
    // EU - базовая система размеров, от которой конвертируем в другие системы
    // [UK, US_M, US_W, UA, CM]
    const SIZE_CONVERSION = {
      '35': ['2.5', '3.5', '5', '35', '22'],
      '35.5': ['3', '4', '5.5', '35.5', '22.5'],
      '36': ['3.5', '4.5', '6', '36', '23'],
      '36.5': ['4', '5', '6.5', '36.5', '23.5'],
      '37': ['4.5', '5.5', '7', '37', '24'],
      '37.5': ['5', '6', '7.5', '37.5', '24.5'],
      '38': ['5.5', '6.5', '8', '38', '25'],
      '38.5': ['6', '7', '8.5', '38.5', '25.5'],
      '39': ['6.5', '7.5', '9', '39', '26'],
      '39.5': ['7', '8', '9.5', '39.5', '26.5'],
      '40': ['7.5', '8.5', '10', '40', '27'],
      '40.5': ['8', '9', '10.5', '40.5', '27.5'],
      '41': ['8.5', '9.5', '11', '41', '28'],
      '41.5': ['9', '10', '11.5', '41.5', '28.5'],
      '42': ['9.5', '10.5', '12', '42', '29'],
      '42.5': ['10', '11', '12.5', '42.5', '29.5'],
      '43': ['10.5', '11.5', '13', '43', '30'],
      '43.5': ['11', '12', '13.5', '43.5', '30.5'],
      '44': ['11.5', '12.5', '14', '44', '31'],
      '44.5': ['12', '13', '14.5', '44.5', '31.5'],
      '45': ['12.5', '13.5', '15', '45', '32'],
      '45.5': ['13', '14', '15.5', '45.5', '32.5'],
      '46': ['13.5', '14.5', '16', '46', '33'],
      '46.5': ['14', '15', '16.5', '46.5', '33.5'],
      '47': ['14.5', '15.5', '17', '47', '34'],
      '47.5': ['15', '16', '17.5', '47.5', '34.5'],
      '48': ['15.5', '16.5', '18', '48', '35'],
      '48.5': ['16', '17', '18.5', '48.5', '35.5'],
      '49': ['16.5', '17.5', '19', '49', '36'],
    };

    // Обратная таблица конвертации (для поиска EU размера по другому стандарту)
    const REVERSE_SIZE_CONVERSION = {
      'UK': {},
      'US': {},
      'UA': {},
      'CM': {}
    };

    // Заполняем обратную таблицу конвертации
    function initializeReverseConversion() {
      Object.entries(SIZE_CONVERSION).forEach(([eu, values]) => {
        const [uk, us, /* us_w */, ua, cm] = values;
        
        if (uk) REVERSE_SIZE_CONVERSION['UK'][uk] = eu;
        if (us) REVERSE_SIZE_CONVERSION['US'][us] = eu;
        if (ua) REVERSE_SIZE_CONVERSION['UA'][ua] = eu;
        if (cm) REVERSE_SIZE_CONVERSION['CM'][cm] = eu;
      });
    }

    // Индекс системы размеров в массиве конвертации
    const SIZE_SYSTEM_INDEX = {
      'UK': 0,
      'US': 1,
      'UA': 3,
      'CM': 4
    };

    let allProducts = [];
    let selectedBrands = [];
    let selectedSizes = [];
    let selectedTypes = [];
    let currentSizeStandard = 'EU'; // По умолчанию используем EU

    function toggleFilter(element) {
      const content = element.nextElementSibling;
      element.classList.toggle('collapsed');
      content.classList.toggle('collapsed');
    }

    function updateCounter(id, count) {
      const counter = document.getElementById(id);
      counter.textContent = count;
      counter.style.display = count > 0 ? 'inline-flex' : 'none';
    }

    function processImageUrl(originalUrl) {
      if (!originalUrl) return null;
      try {
        const url = new URL(originalUrl);
        if (url.hostname === '95.216.46.104') {
          return IMAGE_PROXY + encodeURIComponent(url.href);
        }
        return originalUrl;
      } catch {
        return null;
      }
    }

    function extractFirstPhoto(photoString) {
      if (!photoString) return null;
      const photos = photoString.split(';').map(url => url.trim()).filter(url => url.startsWith('http'));
      return photos.length > 0 ? photos[0] : null;
    }

    function formatPrice(price) {
      if (!price) return "Цена не указана";
      const numericPrice = parseFloat(price.toString().replace(/\s/g, '').replace(',', '.'));
      return isNaN(numericPrice) ? "Цена не указана" : `${numericPrice.toLocaleString('ru-RU')} ₴`;
    }

    function cleanSize(size) {
      return (size || '').toString().replace(/(EU|US|UK|UA|CM)/g, '').trim();
    }

    function validateProduct(item) {
      if (!item || !item.name || !item.brand) return false;
      if (FILTER_CONFIG.excludedBrands.includes(item.brand.trim())) return false;
      const lowerName = item.name.toLowerCase();
      return !FILTER_CONFIG.excludedKeywords.some(keyword => lowerName.includes(keyword.toLowerCase()));
    }

    // Конвертация размера из одной системы в другую
    function convertSize(size, fromSystem, toSystem) {
      // Если системы одинаковые, просто возвращаем размер
      if (fromSystem === toSystem) return size;
      
      // Чистим размер от буквенных обозначений
      const cleanedSize = cleanSize(size);
      
      // Всегда конвертируем через EU, если нужно
      let euSize;
      
      if (fromSystem === 'EU') {
        euSize = cleanedSize;
      } else {
        // Ищем EU размер через обратную таблицу
        euSize = REVERSE_SIZE_CONVERSION[fromSystem][cleanedSize];
        if (!euSize) return null; // Если не нашли соответствие
      }
      
      // Теперь конвертируем из EU в целевую систему
      if (toSystem === 'EU') {
        return euSize;
      }
      
      const conversionData = SIZE_CONVERSION[euSize];
      if (!conversionData) return null;
      
      const targetIndex = SIZE_SYSTEM_INDEX[toSystem];
      return conversionData[targetIndex] || null;
    }

    // Функция для конвертации всех размеров продукта
    function convertProductSizes(product, toSystem) {
      // Создаем копию оригинальных размеров, чтобы не изменять исходные данные
      const originalSizes = [...product.originalSizes];
      const convertedSizes = [];
      
      originalSizes.forEach(size => {
        const converted = convertSize(size, 'EU', toSystem);
        if (converted) {
          convertedSizes.push(converted);
        }
      });
      
      return convertedSizes;
    }

    function compareSizes(a, b) {
      // Преобразуем размеры в числа для правильной сортировки
      const numA = parseFloat(a.replace(',', '.'));
      const numB = parseFloat(b.replace(',', '.'));
      
      // Если оба значения - числа, сортируем по возрастанию
      if (!isNaN(numA) && !isNaN(numB)) {
        return numA - numB;
      }
      
      // Если только одно значение - число
      if (!isNaN(numA)) return -1;
      if (!isNaN(numB)) return 1;
      
      // Если оба значения не числа, сортируем по алфавиту
      return a.localeCompare(b);
    }

    function sortBrands(brands) {
      return [...brands].sort((a, b) => {
        const isAPopular = FILTER_CONFIG.popularBrands.some(brand => 
          a.toLowerCase().includes(brand.toLowerCase()));
        const isBPopular = FILTER_CONFIG.popularBrands.some(brand => 
          b.toLowerCase().includes(brand.toLowerCase()));
        
        // Сначала популярные бренды
        if (isAPopular && !isBPopular) return -1;
        if (!isAPopular && isBPopular) return 1;
        
        // Для популярных брендов используем их порядок в массиве popularBrands
        if (isAPopular && isBPopular) {
          const aIndex = FILTER_CONFIG.popularBrands.findIndex(brand => 
            a.toLowerCase().includes(brand.toLowerCase()));
          const bIndex = FILTER_CONFIG.popularBrands.findIndex(brand => 
            b.toLowerCase().includes(brand.toLowerCase()));
          return aIndex - bIndex;
        }
        
        // Для остальных брендов сортировка по алфавиту
        return a.localeCompare(b);
      });
    }

    async function fetchSheet(sheetId, range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return data.values || [];
      } catch (error) {
        console.error("Ошибка при загрузке данных:", error);
        return [];
      }
    }

    function renderCatalog(products) {
      const container = document.getElementById("catalog");
      if (!products.length) {
        container.innerHTML = `<div class="error">😐 Нет товаров по фильтрам</div>`;
        return;
      }

      // Сортировка по приоритету типов перед отрисовкой
      const sorted = [...products].sort((a, b) => {
        const getPriority = type => FILTER_CONFIG.typePriority[type] || FILTER_CONFIG.typePriority.default;
        return getPriority(a.type) - getPriority(b.type);
      });

      container.innerHTML = sorted.map(item => {
        // Конвертируем размеры для отображения в текущем стандарте
        const displaySizes = currentSizeStandard === 'EU' 
          ? item.sizes 
          : convertProductSizes(item, currentSizeStandard);
        
        return `
          <div class="item">
            <div class="item-img-container">
              <img src="${item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII='}" alt="${item.name}">
            </div>
            <div class="item-content">
              <h3>${item.name}</h3>
              <div class="item-info"><strong>Бренд:</strong> ${item.brand}</div>
              <div class="item-info"><strong>Тип:</strong> ${item.type}</div>
              <div class="item-info">
                <strong>Размеры:</strong>
                <div class="size-type-info">
                  <span class="size-badge">${currentSizeStandard}</span>
                </div>
              </div>
              <div class="sizes">${displaySizes.map(size => `<span class="size">${size}</span>`).join('')}</div>
              <div class="price">${item.price}</div>
            </div>
          </div>
return `
          <div class="item">
            <div class="item-img-container">
              <img src="${item.photo || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII='}" alt="${item.name}">
            </div>
            <div class="item-content">
              <h3>${item.name}</h3>
              <div class="item-info"><strong>Бренд:</strong> ${item.brand}</div>
              <div class="item-info"><strong>Тип:</strong> ${item.type}</div>
              <div class="item-info">
                <strong>Размеры:</strong>
                <div class="size-type-info">
                  <span class="size-badge">${currentSizeStandard}</span>
                </div>
              </div>
              <div class="sizes">${displaySizes.map(size => `<span class="size">${size}</span>`).join('')}</div>
              <div class="price">${item.price}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function applyFilters() {
      selectedBrands = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value);
      selectedTypes = Array.from(document.querySelectorAll('#typeFilters input:checked')).map(el => el.value);
      
      // Получаем выбранные размеры в текущем стандарте
      selectedSizes = Array.from(document.querySelectorAll('#sizeFilters input:checked')).map(el => el.value);
      
      const query = document.getElementById('searchInput').value.toLowerCase();

      updateCounter('brandCounter', selectedBrands.length);
      updateCounter('typeCounter', selectedTypes.length);
      updateCounter('sizeCounter', selectedSizes.length);

      const filtered = allProducts.filter(item => {
        const matchesBrand = selectedBrands.length === 0 || selectedBrands.includes(item.brand);
        const matchesType = selectedTypes.length === 0 || selectedTypes.includes(item.type);
        
        // Проверка соответствия размеров с учетом текущего стандарта
        const matchesSize = selectedSizes.length === 0 || 
          selectedSizes.some(selectedSize => {
            if (currentSizeStandard === 'EU') {
              return item.sizes.includes(selectedSize);
            } else {
              // Конвертируем размер из текущего стандарта в EU для сравнения
              const euSize = convertSize(selectedSize, currentSizeStandard, 'EU');
              return euSize && item.sizes.includes(euSize);
            }
          });
        
        const matchesName = item.name.toLowerCase().includes(query);
        return matchesBrand && matchesType && matchesSize && matchesName;
      });

      renderCatalog(filtered);
    }

    function renderFilterCheckboxes(id, items, sortFunction = null) {
      const container = document.getElementById(id);
      const sortedItems = sortFunction ? sortFunction(items) : [...items].sort();
      
      if (id === 'brandFilters') {
        container.innerHTML = sortedItems.map(item => `
          <label class="${FILTER_CONFIG.popularBrands.some(brand => item.toLowerCase().includes(brand.toLowerCase())) ? 'popular-brand' : ''}">
            <input type="checkbox" value="${item}">${item}
          </label>
        `).join('');
      } else if (id === 'sizeFilters') {
        container.innerHTML = sortedItems.map(item => `
          <label>
            <input type="checkbox" value="${item}">${item}
          </label>
        `).join('');
      } else {
        container.innerHTML = sortedItems.map(item => `
          <label>
            <input type="checkbox" value="${item}">${item}
          </label>
        `).join('');
      }
      
      container.querySelectorAll('input').forEach(el => {
        el.addEventListener('change', applyFilters);
      });
    }

    // Функция для обновления фильтров размеров при изменении стандарта
    function updateSizeFilters(sizeStandard) {
      const euSizes = Array.from(new Set(allProducts.flatMap(p => p.sizes)));
      const convertedSizes = [];
      
      euSizes.forEach(euSize => {
        if (sizeStandard === 'EU') {
          convertedSizes.push(euSize);
        } else {
          const convertedSize = convertSize(euSize, 'EU', sizeStandard);
          if (convertedSize) {
            convertedSizes.push(convertedSize);
          }
        }
      });
      
      // Отсортируем и уберем дубликаты
      const uniqueConvertedSizes = Array.from(new Set(convertedSizes)).sort(compareSizes);
      
      // Сохраняем отмеченные значения перед обновлением
      const checkedValues = Array.from(document.querySelectorAll('#sizeFilters input:checked')).map(el => el.value);
      
      // Рендерим новые фильтры
      renderFilterCheckboxes("sizeFilters", uniqueConvertedSizes, compareSizes);
      
      // Восстанавливаем отмеченные значения, если они все еще существуют в новом стандарте
      if (checkedValues.length) {
        document.querySelectorAll('#sizeFilters input').forEach(input => {
          if (checkedValues.includes(input.value)) {
            input.checked = true;
          }
        });
      }
    }

    async function loadCatalog() {
      try {
        // Инициализируем обратную таблицу конвертации
        initializeReverseConversion();
        
        const [shortData, longData] = await Promise.all([
          fetchSheet(SHEET_ID_SHORT, "TDSheet!A2:Z"),
          fetchSheet(SHEET_ID_LONG, "TDSheet!A2:Z")
        ]);

        const sizeMap = {}, priceMap = {};
        shortData.forEach(row => {
          const article = row[0]?.trim(), size = cleanSize(row[1]), price = row[2];
          if (article) {
            if (!sizeMap[article]) sizeMap[article] = new Set();
            if (size) sizeMap[article].add(size);
            const numPrice = parseFloat((price || '').replace(/\s/g, '').replace(',', '.'));
            if (!isNaN(numPrice)) {
              if (!priceMap[article] || numPrice < priceMap[article]) priceMap[article] = numPrice;
            }
          }
        });

        const brandSet = new Set(), typeSet = new Set(), sizeSet = new Set();
        const uniqueArticles = new Set();
        allProducts = [];

        longData.forEach(row => {
          const article = row[0]?.trim();
          const name = row[1]?.trim();
          const typeRaw = row[16]?.trim();
          const brand = row[15]?.trim();
          const photo = processImageUrl(extractFirstPhoto(row[23]));
          const longPrice = row[18];
          const type = typeRaw === 'Взуття' ? 'Кросівки' : typeRaw;

          if (!article || !name || typeRaw !== "Взуття") return;
          if (uniqueArticles.has(article)) return;

          const sizes = sizeMap[article] ? Array.from(sizeMap[article]).sort(compareSizes) : [];
          const product = {
            article, name, brand: brand || "Не указан", type,
            photo, price: formatPrice(priceMap[article] || longPrice),
            sizes, // EU размеры для хранения
            originalSizes: sizes, // Сохраняем оригинальные размеры для конвертации
          };

          if (validateProduct(product)) {
            allProducts.push(product);
            uniqueArticles.add(article);
            if (product.brand) brandSet.add(product.brand);
            if (product.type) typeSet.add(product.type);
            product.sizes.forEach(s => sizeSet.add(s));
          }
        });

        renderFilterCheckboxes("brandFilters", Array.from(brandSet), sortBrands);
        renderFilterCheckboxes("typeFilters", Array.from(typeSet).sort());
        renderFilterCheckboxes("sizeFilters", Array.from(sizeSet).sort(compareSizes));

        // Инициализация счетчиков фильтров
        updateCounter('brandCounter', 0);
        updateCounter('typeCounter', 0);
        updateCounter('sizeCounter', 0);

        // По умолчанию разворачиваем фильтры
        document.querySelectorAll('.filter-title').forEach(title => {
          if (!title.classList.contains('collapsed')) {
            title.classList.add('collapsed');
            title.nextElementSibling.classList.add('collapsed');
          }
        });
        // Разворачиваем первый фильтр (Бренды)
        const firstFilter = document.querySelector('.filter-title');
        if (firstFilter) {
          firstFilter.classList.remove('collapsed');
          firstFilter.nextElementSibling.classList.remove('collapsed');
        }

        applyFilters();
      } catch (error) {
        console.error("Ошибка при загрузке каталога:", error);
        document.getElementById("catalog").innerHTML = `
          <div class="error">😔 Произошла ошибка при загрузке товаров. Пожалуйста, обновите страницу.</div>
        `;
      }
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    
    // Обработчик изменения стандарта размеров
    document.getElementById("sizeStandard").addEventListener("change", function() {
      currentSizeStandard = this.value;
      
      // Обновляем фильтры размеров в соответствии с выбранным стандартом
      updateSizeFilters(currentSizeStandard);
      
      // Применяем фильтры для обновления списка товаров
      applyFilters();
    });
    
    document.addEventListener("DOMContentLoaded", loadCatalog);
  </script>
</body>
</html>
